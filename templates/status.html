<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Easun Inverter Status</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root {
      --bg: #0e1a32;
      --card: #131f3a;
      --panel: #182649;
      --border: #24355c;
      --accent: #7cd14f;
      --muted: #c6d2f2;
      --text: #f6f8ff;
      --warn: #ffcec2;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, #1c2d56, #0e1a32 45%), #0e1a32;
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
    }
    .navbar {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }
    .navbar-brand {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .nav-menu {
      display: flex;
      gap: 0;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .nav-menu li {
      border-right: 1px solid var(--border);
    }
    .nav-menu li:last-child {
      border-right: none;
    }
    .nav-menu a {
      display: block;
      padding: 8px 16px;
      color: var(--muted);
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s ease;
    }
    .nav-menu a:hover {
      color: var(--accent);
    }
    .nav-menu a.active {
      color: var(--accent);
      background: rgba(124, 209, 79, 0.1);
    }
    .content {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 28px 16px 40px;
      overflow-y: auto;
    }
    .page {
      display: none;
      width: 100%;
      max-width: 1600px;
    }
    .page.active {
      display: block;
    }
    .card {
      width: 100%;
      background: var(--card);
      padding: 20px 22px;
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 38px rgba(0,0,0,0.4);
    }
    h1 { margin: 0 0 6px; font-weight: 700; letter-spacing: 0.01em; color: #ffffff; }
    .meta {
      color: var(--muted);
      margin: 0 0 14px;
      font-size: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      align-items: center;
    }
    .pill {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      color: var(--text);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .pill .dot {
      width: 8px; height: 8px; border-radius: 50%; background: var(--accent);
      display: inline-block;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }
    .item {
      background: var(--panel);
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .label {
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #ffffff;
      margin-bottom: 6px;
    }
    .value { font-size: 20px; font-weight: 700; color: #ffffff; }
    .status {
      margin-top: 14px;
      padding: 11px 14px;
      border-radius: 12px;
      background: rgba(124, 209, 79, 0.08);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .status.error {
      background: rgba(255, 80, 80, 0.12);
      color: var(--warn);
    }
    .flow {
      margin-top: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
    }
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px;
      width: 100%;
    }
    .chart-cell { min-width: 0; }
    .chart-cell canvas {
      width: 100% !important;
      height: 260px !important;
    }
    .actions { margin-top: 12px; }
    .actions a { color: var(--accent); text-decoration: none; font-weight: 600; margin-right: 10px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
  <!-- Navigation Header -->
  <nav class="navbar">
    <a href="#" class="navbar-brand"><i class="bi bi-lightning-charge-fill"></i>Easun Inverter</a>
    <ul class="nav-menu">
      <li><a href="#status" class="nav-link active" data-page="status"><i class="bi bi-speedometer2"></i> Status</a></li>
      <li><a href="#charts" class="nav-link" data-page="charts"><i class="bi bi-graph-up"></i> Charts</a></li>
    </ul>
  </nav>

  <!-- Content Area -->
  <div class="content">
    <!-- STATUS PAGE -->
    <div id="status" class="page active">
      <div class="card">
        <h1>System Status</h1>
        <div class="meta">
          <span class="pill"><span class="dot"></span>Inverter {{ host }}</span>
          {% if local_ip %}<span class="pill">Local {{ local_ip }}</span>{% endif %}
          <span class="pill">Model {{ model }}</span>
          {% if updated_at %}<span class="pill">Updated {{ updated_at }}</span>{% endif %}
        </div>

        {% if error %}
          <div class="status error">Connection error: {{ error }}</div>
        {% else %}
          <!-- Main Status Sections -->
          <div style="display:flex; flex-direction:column; gap:20px;">
            
            <!-- Schedule and Energy Flow Side by Side -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; align-items:start;">
              
              <!-- Electricity Schedule (Left) -->
              <div id="scheduleSection">
                <h2 style="font-size:18px;margin-bottom:10px;color:var(--text);display:flex;align-items:center;gap:8px;">
                  <i class="bi bi-calendar3"></i> Electricity Schedule
                  <span class="pill" style="font-size:11px;margin-left:auto;padding:4px 10px;" id="queueNumberBadge">...</span>
                </h2>
                
                <div id="scheduleLoading" style="text-align:center;padding:30px;color:var(--muted);background:var(--panel);border-radius:12px;border:1px solid var(--border);">
                  <div class="spinner-border spinner-border-sm" role="status" style="width:2rem;height:2rem;">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <div style="margin-top:12px;font-size:13px;">Loading schedule...</div>
                </div>

                <div id="scheduleError" style="display:none;" class="status error"></div>

                <div id="scheduleContent" style="display:none;">
                  <div id="scheduleTodayCompact">
                    <!-- Compact today's schedule -->
                  </div>
                </div>
              </div>

              <!-- Energy Flow Diagram (Right) -->
              <div class="flow" aria-label="Energy flow diagram" style="text-align:center;">
                {% set grid_power_str = (data.grid_power | string)|replace('N/A','0')|replace(' W','')|replace('W','')|trim %}
                {% set grid_voltage_str = (data.grid_voltage | string)|replace('N/A','0')|replace(' V','')|replace('V','')|trim %}
                {% set grid_power_val = grid_power_str|float %}
                {% set grid_voltage_val = grid_voltage_str|float %}
                {% set batt_current_str = (data.battery_current | string)|replace('N/A','0')|replace(' A','')|replace('A','')|trim %}
                {% set batt_current_val = batt_current_str|float %}
                {% set ac_power_val = data.ac_output_power|replace('N/A','0')|float %}
                {% set use_grid = grid_power_val > 0.1 %}
                {% set grid_disconnected = (grid_power_val <= 0.1) or (grid_voltage_val <= 1.0) %}
                <div class="d-flex flex-column align-items-center justify-content-center gap-3" style="font-size:14px;">
                  <div class="d-flex align-items-center justify-content-center gap-3">
                    <div class="d-flex flex-column align-items-center">
                      <div style="position:relative;width:76px;height:76px;">
                        <img src="/static/img/grid_power.png" style="width:76px; height:76px;" alt="Grid">
                        {% if grid_disconnected %}
                          <i class="bi bi-power-off" style="font-size:48px; color:#ffb84d; position:absolute; left:50%; top:50%; transform:translate(-50%, -50%); filter: drop-shadow(0 2px 3px rgba(0,0,0,0.6));"></i>
                        {% endif %}
                      </div>
                      <div class="label" style="font-size:14px;">Grid</div>
                      <div class="label" style="font-size:15px;">{{ data.grid_voltage }} V</div>
                    </div>
                    <img src="/static/img/arrow_right.png" style="width:68px; height:68px;" alt="Arrow">
                    <div class="d-flex flex-column align-items-center">
                      <img src="/static/img/invertor.png" style="width:80px; height:80px;" alt="Inverter">
                      <div class="label" style="font-size:14px;">Inverter</div>
                      <div class="label" style="font-size:15px;">{{ data.status_text }}</div>
                    </div>
                    <img src="/static/img/arrow_right.png" style="width:68px; height:68px;" alt="Arrow">
                    <div class="d-flex flex-column align-items-center">
                      <img src="/static/img/house.png" style="width:80px; height:80px;" alt="Load">
                      <div class="label" style="font-size:14px;">Load</div>
                      <div class="label" style="font-size:15px;">{{ data.ac_output_power }} W</div>
                    </div>
                  </div>
                  <div class="d-flex align-items-center justify-content-center gap-2" style="margin-top:4px;">
                    <div class="d-flex flex-column align-items-center">
                      <img src="/static/img/arrow_{% if batt_current_val < 0 %}up{% else %}down{% endif %}.png" style="width:60px; height:60px;" alt="Arrow">
                      <img id="batteryIcon" src="/static/img/battery_full.svg" style="width:92px; height:92px; margin-top:4px;" alt="Battery">
                      <div class="label" style="font-size:14px;">Battery</div>
                      <div class="label" style="font-size:15px;">{{ data.battery_soc }}% / {{ data.battery_voltage }} V</div>
                      <div class="label" style="font-size:15px;">{{ data.battery_current }} A / {{ data.battery_power }} W</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Detailed Metrics Cards -->
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px;">
              
              <!-- Grid Section -->
              <div class="item" style="padding:16px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:8px;">
                  <i class="bi bi-plug-fill" style="color:var(--accent);font-size:20px;"></i>
                  <div class="label" style="margin:0;font-size:14px;">GRID INPUT</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;color:var(--muted);">Voltage</span>
                    <span style="font-size:16px;font-weight:700;color:var(--text);">{{ data.grid_voltage }} V</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;color:var(--muted);">Power</span>
                    <span style="font-size:16px;font-weight:700;color:var(--text);">{{ data.grid_power }} W</span>
                  </div>
                </div>
              </div>

              <!-- AC Output Section -->
              <div class="item" style="padding:16px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:8px;">
                  <i class="bi bi-house-fill" style="color:var(--accent);font-size:20px;"></i>
                  <div class="label" style="margin:0;font-size:14px;">AC OUTPUT</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;color:var(--muted);">Voltage</span>
                    <span style="font-size:16px;font-weight:700;color:var(--text);">{{ data.ac_output_voltage }} V</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;color:var(--muted);">Frequency</span>
                    <span style="font-size:16px;font-weight:700;color:var(--text);">{{ data.ac_output_freq }} Hz</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;color:var(--muted);">Power</span>
                    <span style="font-size:16px;font-weight:700;color:var(--text);">{{ data.ac_output_power }} W</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;color:var(--muted);">Current</span>
                    <span style="font-size:16px;font-weight:700;color:var(--text);">{{ data.ac_output_current }} A</span>
                  </div>
                </div>
              </div>

              <!-- Battery Section -->
              <div class="item" style="padding:16px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:8px;">
                  <i class="bi bi-battery-charging" style="color:var(--accent);font-size:20px;"></i>
                  <div class="label" style="margin:0;font-size:14px;">BATTERY</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;color:var(--muted);">State of Charge</span>
                    <span style="font-size:18px;font-weight:700;color:var(--accent);">{{ data.battery_soc }} %</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;color:var(--muted);">Voltage</span>
                    <span style="font-size:16px;font-weight:700;color:var(--text);">{{ data.battery_voltage }} V</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;color:var(--muted);">Current</span>
                    <span style="font-size:16px;font-weight:700;color:var(--text);">{{ data.battery_current }} A</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:13px;color:var(--muted);">Temperature</span>
                    <span style="font-size:16px;font-weight:700;color:var(--text);">{{ data.temperature }} &deg;C</span>
                  </div>
                </div>
              </div>

            </div>

            <!-- Tuya Devices Status -->
            <div id="tuyaDevicesSection" style="display:none;">
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;color:var(--muted);font-size:13px;font-weight:600;">
                <i class="bi bi-router"></i> Smart Devices
              </div>
              <div id="tuyaDevicesList" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:8px;"></div>
            </div>

          </div>
        </div>
      </div>
        {% endif %}

        <div class="actions" style="display:none;"></div>
      </div>
    </div>

    <!-- CHARTS PAGE -->
    <div id="charts" class="page">
      <div class="card">
        <h1>Historical Charts</h1>
        <div class="meta">
          <span class="pill"><span class="dot"></span>Inverter {{ host }}</span>
          {% if local_ip %}<span class="pill">Local {{ local_ip }}</span>{% endif %}
        </div>

        <div style="margin-top:18px; display:flex; align-items:center; gap:10px;">
          <span style="font-weight:700;color:var(--muted);">Period</span>
          <div class="btn-group btn-group-sm" role="group" aria-label="Period">
            <button class="btn btn-outline-light" data-days="1">1d</button>
            <button class="btn btn-outline-light" data-days="7">7d</button>
            <button class="btn btn-outline-light" data-days="30">30d</button>
          </div>
        </div>
        <div class="chart-grid" style="margin-top:14px;">
          <div class="chart-cell">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
              <i class="bi bi-lightning-charge"></i> Grid Voltage
            </div>
            <canvas id="chartGridV" aria-label="Grid Voltage chart"></canvas>
          </div>
          <div class="chart-cell">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
              <i class="bi bi-speedometer"></i> Grid Power
            </div>
            <canvas id="chartGridP" aria-label="Grid Power chart"></canvas>
          </div>
          <div class="chart-cell">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
              <i class="bi bi-activity"></i> Grid Current
            </div>
            <canvas id="chartGridA" aria-label="Grid Current chart"></canvas>
          </div>
          <div class="chart-cell">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
              <i class="bi bi-battery-charging"></i> Battery Voltage
            </div>
            <canvas id="chartBattV" aria-label="Battery Voltage chart"></canvas>
          </div>
          <div class="chart-cell">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
              <i class="bi bi-graph-up-arrow"></i> Battery Current
            </div>
            <canvas id="chartBattA" aria-label="Battery Current chart"></canvas>
          </div>
          <div class="chart-cell">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
              <i class="bi bi-plug"></i> Load Power
            </div>
            <canvas id="chartLoadP" aria-label="Load Power chart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const ctxGridV = document.getElementById('chartGridV');
    const ctxGridP = document.getElementById('chartGridP');
    const ctxGridA = document.getElementById('chartGridA');
    const ctxBattV = document.getElementById('chartBattV');
    const ctxBattA = document.getElementById('chartBattA');
    const ctxLoadP = document.getElementById('chartLoadP');
    const periodButtons = document.querySelectorAll('[data-days]');
    let currentDays = null;
    const charts = {};

    // Downsample data intelligently based on time period
    function downsampleData(labels, ...datasets) {
      if (labels.length === 0) return [labels, ...datasets];
      
      // Determine bucket size based on data point count
      const count = labels.length;
      let bucketMinutes;
      if (!currentDays || currentDays <= 1) {
        bucketMinutes = 5; // 5-minute buckets for 1 day
      } else if (currentDays <= 7) {
        bucketMinutes = 15; // 15-minute buckets for 7 days
      } else {
        bucketMinutes = 60; // 1-hour buckets for 30+ days
      }

      const downsampled = [];
      const result = datasets.map(() => []);
      let lastBucket = null;

      for (let i = 0; i < labels.length; i++) {
        const ts = labels[i];
        let bucket;
        try {
          const d = new Date(ts);
          const minutes = Math.floor(d.getMinutes() / bucketMinutes) * bucketMinutes;
          bucket = new Date(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours(), minutes).toISOString();
        } catch {
          bucket = `${i}`;
        }
        
        const isLast = i === labels.length - 1;
        if (bucket !== lastBucket || isLast) {
          downsampled.push(ts);
          datasets.forEach((dataset, idx) => {
            result[idx].push(dataset[i]);
          });
          lastBucket = bucket;
        }
      }
      
      return [downsampled, ...result];
    }

    // Create common chart options
    function getChartOptions(yAxisLabel, unit) {
      const days = currentDays || 1;
      return {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: days > 7 ? 'day' : days > 1 ? 'hour' : 'hour',
              displayFormats: {
                hour: days > 1 ? 'MMM d HH:mm' : 'HH:mm',
                day: 'MMM d'
              },
              tooltipFormat: 'MMM d, yyyy HH:mm'
            },
            ticks: {
              color: '#c6d2f2',
              maxRotation: 45,
              minRotation: 0,
              autoSkip: true,
              maxTicksLimit: days > 7 ? 8 : days > 1 ? 12 : 12
            },
            grid: {
              color: 'rgba(36, 53, 92, 0.5)',
              drawBorder: false
            }
          },
          y: {
            title: {
              display: true,
              text: yAxisLabel,
              color: '#c6d2f2',
              font: { size: 12, weight: 600 }
            },
            ticks: {
              color: '#c6d2f2',
              callback: function(value) {
                return value.toFixed(1) + (unit || '');
              }
            },
            grid: {
              color: 'rgba(36, 53, 92, 0.5)',
              drawBorder: false
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: '#f6f8ff',
              font: { size: 13, weight: 600 },
              padding: 12,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            backgroundColor: 'rgba(19, 31, 58, 0.95)',
            titleColor: '#f6f8ff',
            bodyColor: '#c6d2f2',
            borderColor: '#24355c',
            borderWidth: 1,
            padding: 12,
            displayColors: true,
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) label += ': ';
                if (context.parsed.y !== null) {
                  label += context.parsed.y.toFixed(2) + (unit || '');
                }
                return label;
              }
            }
          }
        }
      };
    }

    // Create dataset config with better styling
    function createDataset(label, data, borderColor) {
      return {
        label: label,
        data: data,
        borderColor: borderColor,
        backgroundColor: borderColor + '20',
        borderWidth: 2.5,
        pointRadius: 0,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: borderColor,
        pointHoverBorderColor: '#ffffff',
        pointHoverBorderWidth: 2,
        tension: 0.3,
        spanGaps: true,
        fill: false
      };
    }

    async function loadHistory() {
      try {
        const url = currentDays ? `/history?days=${currentDays}` : '/history';
        const rows = await (await fetch(url)).json();
        const labels = [];
        const gridV = [], gridP = [], gridA = [];
        const battV = [], battA = [], loadP = [];

        rows.reverse().forEach(r => {
          labels.push(r.created_at || '');
          const p = r.payload || {};
          gridV.push(p.grid_voltage === undefined ? null : Number(p.grid_voltage));
          gridP.push(p.grid_power === undefined ? null : Number(p.grid_power));
          gridA.push(p.grid_current === undefined ? null : Number(p.grid_current));
          battV.push(p.battery_voltage === undefined ? null : Number(p.battery_voltage));
          battA.push(p.battery_current === undefined ? null : Number(p.battery_current));
          loadP.push(p.ac_output_power === undefined ? null : Number(p.ac_output_power));
        });

        // Downsample data for better performance and readability
        const [stepLabels, stepGridV, stepGridP, stepGridA, stepBattV, stepBattA, stepLoadP] = 
          downsampleData(labels, gridV, gridP, gridA, battV, battA, loadP);

        // Grid Voltage Chart
        if (charts.gridV) charts.gridV.destroy();
        charts.gridV = new Chart(ctxGridV, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Grid Voltage', stepGridV, '#4a9eff')]
          },
          options: getChartOptions('Grid Voltage', ' V')
        });

        // Grid Power Chart
        if (charts.gridP) charts.gridP.destroy();
        charts.gridP = new Chart(ctxGridP, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Grid Power', stepGridP, '#ffb84d')]
          },
          options: getChartOptions('Grid Power', ' W')
        });

        // Grid Current Chart
        if (charts.gridA) charts.gridA.destroy();
        charts.gridA = new Chart(ctxGridA, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Grid Current', stepGridA, '#ff6b6b')]
          },
          options: getChartOptions('Grid Current', ' A')
        });

        // Load Power Chart
        if (charts.loadP) charts.loadP.destroy();
        charts.loadP = new Chart(ctxLoadP, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Load Power', stepLoadP, '#a78bfa')]
          },
          options: getChartOptions('Load Power', ' W')
        });

        // Battery Voltage Chart
        if (charts.battV) charts.battV.destroy();
        charts.battV = new Chart(ctxBattV, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Battery Voltage', stepBattV, '#7cd14f')]
          },
          options: getChartOptions('Battery Voltage', ' V')
        });

        // Battery Current Chart
        if (charts.battA) charts.battA.destroy();
        charts.battA = new Chart(ctxBattA, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Battery Current', stepBattA, '#34d399')]
          },
          options: getChartOptions('Battery Current', ' A')
        });

      } catch (e) {
        console.error('History load failed', e);
      }
    }

    periodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        periodButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentDays = btn.getAttribute('data-days');
        loadHistory();
      });
    });
    
    // Update battery icon based on SOC
    function updateBatteryColor() {
      const socText = document.querySelector('[data-days="1"]')?.closest('.card')?.querySelector('[style*="Battery SOC"]')?.parentElement?.textContent || '';
      const socMatch = document.body.textContent.match(/Battery SOC.*?(\d+)/);
      if (socMatch) {
        const soc = parseInt(socMatch[1], 10);
        const icon = document.getElementById('batteryIcon');
        if (icon) {
          if (soc >= 80) {
            icon.src = '/static/img/battery_full.svg';
          } else if (soc >= 50) {
            icon.src = '/static/img/battery_75.svg';
          } else if (soc >= 20) {
            icon.src = '/static/img/battery_50.svg';
          } else {
            icon.src = '/static/img/battery_low.svg';
          }
        }
      }
    }
    
    updateBatteryColor();
    setInterval(updateBatteryColor, 5000);
    
    // Fetch and display Tuya devices
    async function loadTuyaDevices() {
      try {
        const resp = await fetch('/tuya_devices');
        const data = await resp.json();
        
        if (data.error || !Array.isArray(data) || data.length === 0) {
          document.getElementById('tuyaDevicesSection').style.display = 'none';
          return;
        }
        
        const section = document.getElementById('tuyaDevicesSection');
        const list = document.getElementById('tuyaDevicesList');
        
        list.innerHTML = data.map(dev => {
          const statusIcon = dev.switch_on ? '<i class="bi bi-power" style="color:#7cd14f;"></i>' : '<i class="bi bi-power" style="color:#666;"></i>';
          const statusText = dev.switch_on ? 'ON' : 'OFF';
          const statusColor = dev.switch_on ? '#7cd14f' : '#888';
          const bgColor = dev.switch_on ? 'rgba(124, 209, 79, 0.08)' : 'rgba(255,255,255,0.02)';
          const borderColor = dev.switch_on ? 'rgba(124, 209, 79, 0.3)' : 'var(--border)';
          const onlineIcon = dev.online ? '' : '<i class="bi bi-wifi-off" style="font-size:11px;opacity:0.5;margin-right:4px;"></i>';
          
          return `
            <div class="item" style="padding:12px;background:${bgColor};border-color:${borderColor};transition:all 0.3s ease;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                <div class="label" style="margin:0;font-size:12px;display:flex;align-items:center;">
                  ${onlineIcon}${dev.name}
                </div>
                ${statusIcon}
              </div>
              <div style="color:${statusColor};font-size:14px;font-weight:700;letter-spacing:0.02em;">
                ${statusText}
              </div>
            </div>
          `;
        }).join('');
        
        section.style.display = 'block';
      } catch (e) {
        console.error('Failed to load Tuya devices', e);
        document.getElementById('tuyaDevicesSection').style.display = 'none';
      }
    }
    
    loadTuyaDevices();
    setInterval(loadTuyaDevices, 10000);
    
    // Load electricity schedule
    async function loadElectricitySchedule() {
      try {
        const resp = await fetch('/electricity_schedule');
        const result = await resp.json();
        
        if (!result.success) {
          document.getElementById('scheduleLoading').style.display = 'none';
          document.getElementById('scheduleError').textContent = 'Failed to load schedule: ' + (result.error || 'Unknown error');
          document.getElementById('scheduleError').style.display = 'block';
          return;
        }
        
        const data = result.data;
        const queueNum = result.queue;
        
        if (!data || data.length === 0) {
          document.getElementById('scheduleLoading').style.display = 'none';
          document.getElementById('scheduleError').textContent = 'No schedule data available';
          document.getElementById('scheduleError').style.display = 'block';
          return;
        }
        
        // Update queue number badge
        document.getElementById('queueNumberBadge').textContent = 'Queue: ' + queueNum;
        
        // Display compact schedule for up to 2 days
        const scheduleCompact = document.getElementById('scheduleTodayCompact');
        let compactHTML = '';
        
        const now = new Date();
        
        // Process up to 2 days
        const daysToShow = data.slice(0, 2);
        daysToShow.forEach((daySchedule, dayIndex) => {
          const eventDate = daySchedule.eventDate;
          const queues = daySchedule.queues[queueNum] || [];
          
          // Parse eventDate (format: "18.01.2026")
          const [day, month, year] = eventDate.split('.').map(Number);
          const eventDateTime = new Date(year, month - 1, day);
          
          // Add day separator if showing multiple days
          if (dayIndex > 0) {
            compactHTML += `<div style="margin:20px 0;border-top:1px solid var(--border);padding-top:16px;"></div>`;
          }
          
          compactHTML += `<div style="margin-bottom:8px;font-size:14px;font-weight:700;color:var(--muted);">${eventDate}</div>`;
          
          if (queues.length === 0) {
            compactHTML += `
              <div class="item" style="background:rgba(124,209,79,0.08);border-color:rgba(124,209,79,0.3);padding:16px;">
                <div style="display:flex;align-items:center;gap:12px;">
                  <i class="bi bi-check-circle-fill" style="color:#7cd14f;font-size:28px;"></i>
                  <div>
                    <div style="font-size:16px;color:var(--text);font-weight:700;">No scheduled outages</div>
                  </div>
                </div>
              </div>
            `;
          } else {
            compactHTML += `<div style="display:grid;gap:10px;">`;
            queues.forEach((slot) => {
              const duration = calculateDuration(slot.from, slot.to);
              const [fromHour, fromMin] = slot.from.split(':').map(Number);
              const [toHour, toMin] = slot.to.split(':').map(Number);
              const fromTime = new Date(eventDateTime.getFullYear(), eventDateTime.getMonth(), eventDateTime.getDate(), fromHour, fromMin);
              const toTime = new Date(eventDateTime.getFullYear(), eventDateTime.getMonth(), eventDateTime.getDate(), toHour, toMin);
              const isActive = now >= fromTime && now <= toTime;
              const isPending = now < fromTime;
              
              compactHTML += `
                <div class="item" style="background:rgba(255,80,80,0.08);border-color:rgba(255,80,80,0.3);padding:14px;${isActive ? 'border:2px solid #ff5050;' : ''}">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div style="display:flex;align-items:center;gap:12px;">
                      <i class="bi bi-${isActive ? 'power' : 'clock'}" style="color:#ff5050;font-size:24px;"></i>
                      <div>
                        <div style="font-size:16px;color:var(--text);font-weight:700;">${slot.shutdownHours}</div>
                        <div style="font-size:12px;color:var(--muted);margin-top:2px;">${duration}</div>
                      </div>
                    </div>
                    ${isActive ? '<div style="padding:5px 14px;background:rgba(255,80,80,0.3);border-radius:999px;font-size:12px;font-weight:700;color:#fff;text-transform:uppercase;"><i class="bi bi-exclamation-triangle-fill"></i> Active Now</div>' : ''}
                    ${isPending ? '<div style="padding:5px 14px;background:rgba(255,206,86,0.2);border-radius:999px;font-size:11px;font-weight:600;color:#ffce56;text-transform:uppercase;">Upcoming</div>' : ''}
                  </div>
                </div>
              `;
            });
            compactHTML += `</div>`;
          }
        });
        
        scheduleCompact.innerHTML = compactHTML;
        
        document.getElementById('scheduleLoading').style.display = 'none';
        document.getElementById('scheduleContent').style.display = 'block';
        
      } catch (e) {
        console.error('Failed to load schedule', e);
        document.getElementById('scheduleLoading').style.display = 'none';
        document.getElementById('scheduleError').textContent = 'Failed to load schedule: ' + e.message;
        document.getElementById('scheduleError').style.display = 'block';
      }
    }
    
    function calculateDuration(from, to) {
      const [fromHour, fromMin] = from.split(':').map(Number);
      const [toHour, toMin] = to.split(':').map(Number);
      const fromMinutes = fromHour * 60 + fromMin;
      let toMinutes = toHour * 60 + toMin;
      
      // Handle times spanning midnight (e.g., 21:00-00:00)
      if (toMinutes <= fromMinutes) {
        toMinutes += 24 * 60; // Add 24 hours
      }
      
      const duration = toMinutes - fromMinutes;
      const hours = Math.floor(duration / 60);
      const minutes = duration % 60;
      if (hours > 0 && minutes > 0) {
        return `${hours}h ${minutes}m`;
      } else if (hours > 0) {
        return `${hours}h`;
      } else {
        return `${minutes}m`;
      }
    }
    
    // Page Navigation
    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      
      const page = document.getElementById(pageName);
      if (page) {
        page.classList.add('active');
        document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
        
        // Load data when page is shown
        if (pageName === 'charts' && !currentDays) {
          currentDays = '1';
          loadHistory();
        }
      }
    }
    
    // Navigate on link click
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const pageName = link.getAttribute('data-page');
        history.pushState(null, '', '#' + pageName);
        showPage(pageName);
      });
    });
    
    // Handle browser back/forward
    window.addEventListener('hashchange', () => {
      const pageName = window.location.hash.slice(1) || 'status';
      showPage(pageName);
    });
    
    // Load initial data
    currentDays = '1';
    loadHistory();
    loadElectricitySchedule();
    
    // Reduced reload interval to 5 min to save RPi4 load
    setInterval(() => {
      // Only refresh data, don't reload page
      loadTuyaDevices();
      loadBatteryDevices();
      loadElectricitySchedule();
      if (document.getElementById('charts').classList.contains('active')) {
        loadHistory();
      }
    }, 60000);
  </script>
</body>
</html>
