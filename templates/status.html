<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Easun Inverter Status</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root {
      --bg: #0e1a32;
      --card: #131f3a;
      --panel: #182649;
      --border: #24355c;
      --accent: #7cd14f;
      --muted: #c6d2f2;
      --text: #f6f8ff;
      --warn: #ffcec2;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, #1c2d56, #0e1a32 45%), #0e1a32;
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 28px 16px 40px;
    }
    .card {
      width: min(100%, 100%);
      max-width: 1600px;
      background: var(--card);
      padding: 20px 22px;
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 38px rgba(0,0,0,0.4);
    }
    h1 { margin: 0 0 6px; font-weight: 700; letter-spacing: 0.01em; color: #ffffff; }
    .meta {
      color: var(--muted);
      margin: 0 0 14px;
      font-size: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      align-items: center;
    }
    .pill {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      color: var(--text);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .pill .dot {
      width: 8px; height: 8px; border-radius: 50%; background: var(--accent);
      display: inline-block;
    }
    .dash {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      align-items: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }
    .item {
      background: var(--panel);
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .label {
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #ffffff;
      margin-bottom: 6px;
    }
    .value { font-size: 20px; font-weight: 700; color: #ffffff; }
    .status {
      margin-top: 14px;
      padding: 11px 14px;
      border-radius: 12px;
      background: rgba(124, 209, 79, 0.08);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .status.error {
      background: rgba(255, 80, 80, 0.12);
      color: var(--warn);
    }
    .flow {
      margin-top: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
    }
    .flow text { fill: #ffffff; font-family: "Segoe UI", sans-serif; }
    .flow .label { font-size: 12px; fill: #ffffff; }
    .flow .value { font-size: 14px; font-weight: 700; fill: #ffffff; }
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px;
      width: 100%;
    }
    .chart-cell { min-width: 0; }
    .chart-cell canvas {
      width: 100% !important;
      height: 260px !important;
    }
    .node {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      grid-template-columns: 64px 1fr;
      column-gap: 12px;
      align-items: center;
    }
    .circle {
      width: 64px; height: 64px;
      border-radius: 50%;
      border: 3px solid var(--accent);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: var(--text);
      position: relative;
    }
    .circle::after {
      content: '';
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      border: 1px dashed var(--accent);
      opacity: 0.7;
    }
    .node h3 { margin: 0 0 4px; font-size: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .node .value { font-size: 18px; font-weight: 700; }
    .node .sub { font-size: 13px; color: var(--muted); }
    .center {
      text-align: center;
      padding: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(111, 187, 76, 0.1);
      border: 1px solid var(--border);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }
    .grid-line {
      height: 2px;
      background: linear-gradient(90deg, transparent 0%, var(--accent) 40%, var(--accent) 60%, transparent 100%);
      opacity: 0.6;
      margin: 4px 0;
    }
    .actions { margin-top: 12px; }
    .actions a { color: var(--accent); text-decoration: none; font-weight: 600; margin-right: 10px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>Easun Inverter</h1>
    <div class="meta">
      <span class="pill"><span class="dot"></span>Inverter {{ host }}</span>
      {% if local_ip %}<span class="pill">Local {{ local_ip }}</span>{% endif %}
      <span class="pill">Model {{ model }}</span>
      {% if updated_at %}<span class="pill">Updated {{ updated_at }}</span>{% endif %}
    </div>

    {% if error %}
      <div class="status error">Connection error: {{ error }}</div>
    {% else %}
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px; align-items:start;">
        <div>
          <div class="grid" style="grid-template-columns: 1fr;">
            <div class="item"><div class="label">Grid V</div><div class="value">{{ data.grid_voltage }} V</div></div>
            <div class="item"><div class="label">Grid Power</div><div class="value">{{ data.grid_power }} W</div></div>
            <div class="item"><div class="label">AC Out V</div><div class="value">{{ data.ac_output_voltage }} V</div></div>
            <div class="item"><div class="label">AC Out Hz</div><div class="value">{{ data.ac_output_freq }} Hz</div></div>
            <div class="item"><div class="label">AC Power</div><div class="value">{{ data.ac_output_power }} W</div></div>
            <div class="item"><div class="label">AC Current</div><div class="value">{{ data.ac_output_current }} A</div></div>
            <div class="item"><div class="label">Battery V</div><div class="value">{{ data.battery_voltage }} V</div></div>
            <div class="item"><div class="label">Battery A</div><div class="value">{{ data.battery_current }} A</div></div>
            <div class="item"><div class="label">Battery SOC</div><div class="value">{{ data.battery_soc }} %</div></div>
            <div class="item"><div class="label">Temp</div><div class="value">{{ data.temperature }} &deg;C</div></div>
          </div>
        </div>
          <div style="display:flex; flex-direction:column; gap:14px;">
          <div class="flow" aria-label="Energy flow diagram" style="text-align:center;">
            {% set grid_power_val = data.grid_power|replace('N/A','0')|float %}
            {% set batt_current_val = data.battery_current|replace('N/A','0')|float %}
            {% set ac_power_val = data.ac_output_power|replace('N/A','0')|float %}
            {% set use_grid = grid_power_val > 0.1 %}
            <div class="d-flex flex-column align-items-center justify-content-center gap-3" style="font-size:14px;">
              <div class="d-flex align-items-center justify-content-center gap-3">
                <div class="d-flex flex-column align-items-center">
                  <i class="bi bi-lightning-charge-fill" style="font-size:38px; color:#7cd14f;"></i>
                  <div class="label" style="font-size:14px;">Grid</div>
                  <div class="label" style="font-size:15px;">{{ data.grid_voltage }} V</div>
                </div>
                <i class="bi bi-arrow-right-circle" style="font-size:34px; color:#5fae3f;"></i>
                <div class="d-flex flex-column align-items-center">
                  <i class="bi bi-hdd-network" style="font-size:40px; color:#5fae3f;"></i>
                  <div class="label" style="font-size:14px;">Inverter</div>
                  <div class="label" style="font-size:15px;">{{ data.status_text }}</div>
                </div>
                <i class="bi bi-arrow-right-circle" style="font-size:34px; color:#5fae3f;"></i>
                <div class="d-flex flex-column align-items-center">
                  <i class="bi bi-house-fill" style="font-size:40px; color:#7cd14f;"></i>
                  <div class="label" style="font-size:14px;">Load</div>
                  <div class="label" style="font-size:15px;">{{ data.ac_output_power }} W</div>
                </div>
          </div>
                <div class="d-flex align-items-center justify-content-center gap-2" style="margin-top:4px;">
                  <div class="d-flex flex-column align-items-center">
                    <i class="bi {% if use_grid %}bi-arrow-down-circle{% else %}bi-arrow-up-circle{% endif %}" style="font-size:30px; color:#5fae3f;"></i>
                    <i class="bi bi-battery-full" id="batteryIcon" style="font-size:46px; color:#5fae3f; margin-top:4px;"></i>
                    <div class="label" style="font-size:14px;">Battery</div>
                    <div class="label" style="font-size:15px;">{{ data.battery_soc }}% / {{ data.battery_voltage }} V</div>
                    <div class="label" style="font-size:15px;">{{ data.battery_current }} A / {{ data.battery_power }} W</div>
                  </div>
                </div>
        </div>

          <!-- Tuya Devices Status -->
          <div id="tuyaDevicesSection" style="display:none;">
            <div style="font-weight:700;color:var(--muted);margin-bottom:8px;text-align:center;">üì± Smart Devices</div>
            <div id="tuyaDevicesList" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:8px;"></div>
          </div>
          </div>
        </div>
      </div>

      <div style="margin-top:18px; display:flex; align-items:center; gap:10px;">
        <span style="font-weight:700;color:var(--muted);">History</span>
        <a href="/" class="btn btn-sm btn-outline-success" style="padding:6px 12px; border-radius:8px;">Refresh</a>
        <div class="btn-group btn-group-sm" role="group" aria-label="Period">
          <button class="btn btn-outline-light" data-days="1">1d</button>
          <button class="btn btn-outline-light" data-days="7">7d</button>
          <button class="btn btn-outline-light" data-days="30">30d</button>
        </div>
      </div>
      <div class="chart-grid" style="margin-top:6px;">
        <div class="chart-cell">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
            <i class="bi bi-lightning-charge"></i> Grid Voltage
          </div>
          <canvas id="chartGridV" aria-label="Grid Voltage chart"></canvas>
        </div>
        <div class="chart-cell">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
            <i class="bi bi-speedometer"></i> Grid Power
          </div>
          <canvas id="chartGridP" aria-label="Grid Power chart"></canvas>
        </div>
        <div class="chart-cell">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
            <i class="bi bi-activity"></i> Grid Current
          </div>
          <canvas id="chartGridA" aria-label="Grid Current chart"></canvas>
        </div>
        <div class="chart-cell">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
            <i class="bi bi-battery-charging"></i> Battery Voltage
          </div>
          <canvas id="chartBattV" aria-label="Battery Voltage chart"></canvas>
        </div>
        <div class="chart-cell">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
            <i class="bi bi-graph-up-arrow"></i> Battery Current
          </div>
          <canvas id="chartBattA" aria-label="Battery Current chart"></canvas>
        </div>
        <div class="chart-cell">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;color:var(--muted);font-size:13px;font-weight:600;">
            <i class="bi bi-plug"></i> Load Power
          </div>
          <canvas id="chartLoadP" aria-label="Load Power chart"></canvas>
        </div>
      </div>
    {% endif %}

    <div class="actions" style="display:none;"></div>
  </div>
  <script>
    const ctxGridV = document.getElementById('chartGridV');
    const ctxGridP = document.getElementById('chartGridP');
    const ctxGridA = document.getElementById('chartGridA');
    const ctxBattV = document.getElementById('chartBattV');
    const ctxBattA = document.getElementById('chartBattA');
    const ctxLoadP = document.getElementById('chartLoadP');
    const periodButtons = document.querySelectorAll('[data-days]');
    let currentDays = null;
    const charts = {};

    // Downsample data intelligently based on time period
    function downsampleData(labels, ...datasets) {
      if (labels.length === 0) return [labels, ...datasets];
      
      // Determine bucket size based on data point count
      const count = labels.length;
      let bucketMinutes;
      if (!currentDays || currentDays <= 1) {
        bucketMinutes = 5; // 5-minute buckets for 1 day
      } else if (currentDays <= 7) {
        bucketMinutes = 15; // 15-minute buckets for 7 days
      } else {
        bucketMinutes = 60; // 1-hour buckets for 30+ days
      }

      const downsampled = [];
      const result = datasets.map(() => []);
      let lastBucket = null;

      for (let i = 0; i < labels.length; i++) {
        const ts = labels[i];
        let bucket;
        try {
          const d = new Date(ts);
          const minutes = Math.floor(d.getMinutes() / bucketMinutes) * bucketMinutes;
          bucket = new Date(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours(), minutes).toISOString();
        } catch {
          bucket = `${i}`;
        }
        
        const isLast = i === labels.length - 1;
        if (bucket !== lastBucket || isLast) {
          downsampled.push(ts);
          datasets.forEach((dataset, idx) => {
            result[idx].push(dataset[i]);
          });
          lastBucket = bucket;
        }
      }
      
      return [downsampled, ...result];
    }

    // Create common chart options
    function getChartOptions(yAxisLabel, unit) {
      const days = currentDays || 1;
      return {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: days > 7 ? 'day' : days > 1 ? 'hour' : 'hour',
              displayFormats: {
                hour: days > 1 ? 'MMM d HH:mm' : 'HH:mm',
                day: 'MMM d'
              },
              tooltipFormat: 'MMM d, yyyy HH:mm'
            },
            ticks: {
              color: '#c6d2f2',
              maxRotation: 45,
              minRotation: 0,
              autoSkip: true,
              maxTicksLimit: days > 7 ? 8 : days > 1 ? 12 : 12
            },
            grid: {
              color: 'rgba(36, 53, 92, 0.5)',
              drawBorder: false
            }
          },
          y: {
            title: {
              display: true,
              text: yAxisLabel,
              color: '#c6d2f2',
              font: { size: 12, weight: 600 }
            },
            ticks: {
              color: '#c6d2f2',
              callback: function(value) {
                return value.toFixed(1) + (unit || '');
              }
            },
            grid: {
              color: 'rgba(36, 53, 92, 0.5)',
              drawBorder: false
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: '#f6f8ff',
              font: { size: 13, weight: 600 },
              padding: 12,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            backgroundColor: 'rgba(19, 31, 58, 0.95)',
            titleColor: '#f6f8ff',
            bodyColor: '#c6d2f2',
            borderColor: '#24355c',
            borderWidth: 1,
            padding: 12,
            displayColors: true,
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) label += ': ';
                if (context.parsed.y !== null) {
                  label += context.parsed.y.toFixed(2) + (unit || '');
                }
                return label;
              }
            }
          }
        }
      };
    }

    // Create dataset config with better styling
    function createDataset(label, data, borderColor) {
      return {
        label: label,
        data: data,
        borderColor: borderColor,
        backgroundColor: borderColor + '20',
        borderWidth: 2.5,
        pointRadius: 0,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: borderColor,
        pointHoverBorderColor: '#ffffff',
        pointHoverBorderWidth: 2,
        tension: 0.3,
        spanGaps: true,
        fill: false
      };
    }

    async function loadHistory() {
      try {
        const url = currentDays ? `/history?days=${currentDays}` : '/history';
        const rows = await (await fetch(url)).json();
        const labels = [];
        const gridV = [], gridP = [], gridA = [];
        const battV = [], battA = [], loadP = [];

        rows.reverse().forEach(r => {
          labels.push(r.created_at || '');
          const p = r.payload || {};
          gridV.push(p.grid_voltage === undefined ? null : Number(p.grid_voltage));
          gridP.push(p.grid_power === undefined ? null : Number(p.grid_power));
          gridA.push(p.grid_current === undefined ? null : Number(p.grid_current));
          battV.push(p.battery_voltage === undefined ? null : Number(p.battery_voltage));
          battA.push(p.battery_current === undefined ? null : Number(p.battery_current));
          loadP.push(p.ac_output_power === undefined ? null : Number(p.ac_output_power));
        });

        // Downsample data for better performance and readability
        const [stepLabels, stepGridV, stepGridP, stepGridA, stepBattV, stepBattA, stepLoadP] = 
          downsampleData(labels, gridV, gridP, gridA, battV, battA, loadP);

        // Grid Voltage Chart
        if (charts.gridV) charts.gridV.destroy();
        charts.gridV = new Chart(ctxGridV, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Grid Voltage', stepGridV, '#4a9eff')]
          },
          options: getChartOptions('Grid Voltage', ' V')
        });

        // Grid Power Chart
        if (charts.gridP) charts.gridP.destroy();
        charts.gridP = new Chart(ctxGridP, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Grid Power', stepGridP, '#ffb84d')]
          },
          options: getChartOptions('Grid Power', ' W')
        });

        // Grid Current Chart
        if (charts.gridA) charts.gridA.destroy();
        charts.gridA = new Chart(ctxGridA, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Grid Current', stepGridA, '#ff6b6b')]
          },
          options: getChartOptions('Grid Current', ' A')
        });

        // Load Power Chart
        if (charts.loadP) charts.loadP.destroy();
        charts.loadP = new Chart(ctxLoadP, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Load Power', stepLoadP, '#a78bfa')]
          },
          options: getChartOptions('Load Power', ' W')
        });

        // Battery Voltage Chart
        if (charts.battV) charts.battV.destroy();
        charts.battV = new Chart(ctxBattV, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Battery Voltage', stepBattV, '#7cd14f')]
          },
          options: getChartOptions('Battery Voltage', ' V')
        });

        // Battery Current Chart
        if (charts.battA) charts.battA.destroy();
        charts.battA = new Chart(ctxBattA, {
          type: 'line',
          data: { 
            labels: stepLabels, 
            datasets: [createDataset('Battery Current', stepBattA, '#34d399')]
          },
          options: getChartOptions('Battery Current', ' A')
        });

      } catch (e) {
        console.error('History load failed', e);
      }
    }

    periodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        periodButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentDays = btn.getAttribute('data-days');
        loadHistory();
      });
    });
    
    // Update battery icon color based on SOC
    function updateBatteryColor() {
      const socText = document.querySelector('[data-days="1"]')?.closest('.card')?.querySelector('[style*="Battery SOC"]')?.parentElement?.textContent || '';
      const socMatch = document.body.textContent.match(/Battery SOC.*?(\d+)/);
      if (socMatch) {
        const soc = parseInt(socMatch[1], 10);
        const icon = document.getElementById('batteryIcon');
        if (icon) {
          if (soc >= 80) {
            icon.style.color = '#7cd14f';  // Green
          } else if (soc >= 50) {
            icon.style.color = '#fbbf24';  // Yellow/Amber
          } else if (soc >= 20) {
            icon.style.color = '#f97316';  // Orange
          } else {
            icon.style.color = '#ef4444';  // Red
          }
        }
      }
    }
    
    updateBatteryColor();
    setInterval(updateBatteryColor, 5000);
    
    // Fetch and display Tuya devices
    async function loadTuyaDevices() {
      try {
        const resp = await fetch('/tuya_devices');
        const data = await resp.json();
        
        if (data.error || !Array.isArray(data) || data.length === 0) {
          document.getElementById('tuyaDevicesSection').style.display = 'none';
          return;
        }
        
        const section = document.getElementById('tuyaDevicesSection');
        const list = document.getElementById('tuyaDevicesList');
        
        list.innerHTML = data.map(dev => {
          const statusIcon = dev.switch_on ? '‚úÖ' : '‚ùå';
          const statusText = dev.switch_on ? 'ON' : 'OFF';
          const statusColor = dev.switch_on ? '#7cd14f' : '#ff5050';
          const onlineText = dev.online ? '' : ' (offline)';
          
          return `
            <div class="item" style="display:flex; flex-direction:column; gap:4px;">
              <div class="label">${dev.name}${onlineText}</div>
              <div class="value" style="color:${statusColor}; font-size:16px;">
                ${statusIcon} ${statusText}
              </div>
            </div>
          `;
        }).join('');
        
        section.style.display = 'block';
      } catch (e) {
        console.error('Failed to load Tuya devices', e);
        document.getElementById('tuyaDevicesSection').style.display = 'none';
      }
    }
    
    loadTuyaDevices();
    setInterval(loadTuyaDevices, 10000);
    
    loadHistory();
    setInterval(() => window.location.reload(), 60000);
  </script>
</body>
</html>
